# Data Cleaning and Feature Engineering
{: #top}

<br>

## Waterbodies: 

### [1. Aquifers](#aquifers)

#### [1.1 Doganella](#doganella)

#### [1.2 Luco](#luco)

#### [1.3 Auser](#auser)

### [2. Water Springs](#springs)

#### [2.1 Lupa](#lupa)

#### [2.2 Madonna di Canneto](#canneto)

### [3. River Arno](#arno)

### [4. Lake Bilancino](#bilancino)

-------------------------------------------------------------

<br>

## 1 Aquifers
{: #aquifers}

### 1.1 Doganella 
{: #doganella}

Doganella has 9 target variables for each well which characterises the aquifer, all reflecting **depth to groundwater (m)**.

First thing we observe of the target variables is that around **60%** of data is missing, particularly in the early years of the dataset. 

Not only the target variables, but also their features present a large percentage of missing values. In particular, volumes lack 70% of their values, followed by 30% of temperature values and 10% of rainfall values. 

For this reason, we decided to filter out the dataset for the largest gap present in well 1 (77.5%).

The largest portion remaining of missing data was found in meteorological and target variables. 

```
# A tibble: 15 x 3
   variable                n_miss pct_miss
   <chr>                    <int>    <dbl>
 1 Temperature Monteporzio   7245   59.1  
 2 Temperature Velletri      7236   59.0  
 3 Rainfall Monteporzio      3186   26.0  
 4 Rainfall Velletri         2430   19.8  
 5 Depth to groundwater      2329   19.0  
```
We first imputed the missing target values by substituting them with their dynamic average. 

![imp_vis](https://user-images.githubusercontent.com/43357858/108858042-04e85a00-75ec-11eb-9592-c3fd503832e1.jpg)

We did the same for volume variables.

![imp_volumes](https://user-images.githubusercontent.com/43357858/108874213-3bc66c00-75fc-11eb-9d1f-769f9e4564f4.jpg)

Then, we enriched meteorological data by integrating them with data we found and retrieved from [3bmeteo.com/Velletri](3bmeteo.com/meteo/velletri/storico) and [3bmeteo.com/Monteporzio](https://www.3bmeteo.com/meteo/monte+porzio+catone/storico).

![panel_meteo](https://user-images.githubusercontent.com/43357858/108879215-54855080-7601-11eb-8ef5-3ce2250fe41b.jpg)

#### Outliers 

We looked at the frequency distribution of the target variables by creating boxplots. 

![boxplot_target](https://user-images.githubusercontent.com/43357858/108859183-3f9ec200-75ed-11eb-8701-de6fff7265f4.jpg)

We decided to substitute the largest outlier found in wells 2 and 8 with their respective value at Q3. We decided not to modify the remaining outliers as they were many and scattered throughout the timeseries.  

### 1.2 Luco 
{: #luco}

Luco aquifer presents 4 target variables for each of the 4 wells, reflecting **depth to groundwater (m)**.

Large data gap found particularly in the first years of the timeseries, both for meteorological and target variables.

![Immagine1](https://user-images.githubusercontent.com/43357858/109385146-f652b900-78f1-11eb-8efd-ba468e1b11af.png)

#### Target variable: depth to groundwater (m)

We visualised target value distribution over the years, for the 4 wells. The initial data gap is clearly evident. For this reason we filtered out the dataset up until 2016.

In addition, Podere Casetta lacks data in the more recent years, which are too important for modelling and forecasting and could not be retrieved from other sources. Also well 4 presents variations which can hardly be attributed to natural and stochastic phenomena, and rather indicate dependency to anthropogenic and artificial factors that we could not identify from the dataset. We therfore decided to **remove those targets from our analysis**.

![plot1](https://user-images.githubusercontent.com/43357858/109385301-1b93f700-78f3-11eb-9b46-60d4fba70871.jpg)

We proceeded with the analysis on target variables from wells 1 and 3, as they present up to date and coherent data with respect to their waterbody. 

![plot_pozzi1e3](https://user-images.githubusercontent.com/43357858/109385327-3fefd380-78f3-11eb-9235-bc9dc4841783.jpg)

These wells still present few data gaps over the timeseries, as you can see below. 

Well 1 (no abs. value):

![na_pozzo1](https://user-images.githubusercontent.com/43357858/109385367-93622180-78f3-11eb-8067-802de77eabf2.jpg)

Well 2 (no abs. value):

![na_pozzo2](https://user-images.githubusercontent.com/43357858/109385368-93fab800-78f3-11eb-8c2f-9ad0e932591b.jpg)

We filled those gaps by imputing their moving average. You can see the result below (no abs. value):

![no_na](https://user-images.githubusercontent.com/43357858/109415295-25cbf900-79b8-11eb-9eee-be6cda217ec9.jpg)

##### Outliers 

We found outliers in well 1.

![out_target](https://user-images.githubusercontent.com/43357858/109385535-d96bb500-78f4-11eb-91ba-b4fb1eb85be8.jpg)

Thus, we decided to substitute them with the equivalent of the upper quartile value in the distribution. 

![no_out](https://user-images.githubusercontent.com/43357858/109385536-da044b80-78f4-11eb-8298-abc1e5ad9cb0.jpg)

#### Features: meteorological 

Features did not present any missing values, nor outliers to take into consideration. So we left them as they were. 

#### Feature selection and engineering 

We created a correlation matrix between all variables in the dataset, finding a strong correlation within and between rainfall and temperature values (as expected).

![corrplot](https://user-images.githubusercontent.com/43357858/109385567-10da6180-78f5-11eb-9dd5-63474fb6f609.jpeg)

From the meteorological variables, we decided to keep temperature from Mensano locality and rainfall from Mensano and Montalcinello localities. 

We engineered seasons, absence/presence of snow, set new minimum rainfall thresholds at 5 mm, 10 mm, 15 mm and 30 mm, and added +1, +3, +5, +6, +7, +9 days of lag between rainfall and target variables. 

### 1.3 Auser 
{: #auser}

Auser presents data from five different wells, which are subdivided into two groups: the Northern wells, where SAL, PAG, CoS and DIEC are found, and the Southern wells, with LT2. Out of these wells, three present our target variables (SAL, CoS, LT2).

We first visualised the dataset and noticed that, like the others, it presented large gaps in the earlier years. 

![01Auser](https://user-images.githubusercontent.com/43357858/109395125-0aff7300-792b-11eb-85a9-acf1752b01d7.jpg)

We found that target data lacked more than half their values, as did feature variables - i.e. rainfall. You can see the percentage of missing data in greater detail below. 

```
# A tibble: 27 x 3
      variable                     n_miss    pct_miss
        <chr>                       <int>      <dbl>
1 Depth_to_Groundwater_DIEC         4884       59.9
2 Depth_to_Groundwater_PAG          4347       53.3
3 Depth_to_Groundwater_CoS          3839       47.1
4 Depth_to_Groundwater_SAL          3609       44.3
5 Depth_to_Groundwater_LT2          3352       41.1
6 Rainfall_Piaggione                3224       39.5
7 Rainfall_Monte_Serra              2865       35.1
```

### Target variable: depth to groundwater (m)

We filtered out the dataset to minimise the amount of missing data for the target variables, as these could not be retrieved from external sources. 

The division between Northern and Southern wells is more clear by looking at their behaviour over time (absolute values).

![04AUSER_filtered_depth_to_groundwater](https://user-images.githubusercontent.com/43357858/109395134-15217180-792b-11eb-8c5c-227b25f78333.jpg)

We observed in more detail where the remaining missing (after the filtering) were located over time, and decided to impute their values by calculating the moving average. 

![32auser_target_no_missing](https://user-images.githubusercontent.com/43357858/109395144-21a5ca00-792b-11eb-9440-42dfc557ca7d.jpg)

Then we checked for outliers. For repeating outliers, as in the case of SAL well, we could not intervene. In the case of CoS, which had an outlier equal to 0, we subsituted the value with the value of the lowest quartile in the distribution. 

```
Grubbs test for one outlier:
Data: auser (CoS)

G = 4.77370, U = 0.99569, p-value = 0.004673

Alternative hypothesis: lowest value 0 is an outlier
```

![16box_auser_pozzi](https://user-images.githubusercontent.com/43357858/109395154-2e2a2280-792b-11eb-9f7d-15693ae80d56.jpg)

### Feature variables 

#### Temperature 

No outliers are present in the temperature variables. 

![23auser_temp](https://user-images.githubusercontent.com/43357858/109396958-6f730000-7934-11eb-8b83-c652e1db7b53.jpg)

We noticed that for the sensor in Ponte a Moriano, from 2017 values result 0 째C for consecutive months - we therefore decided to **exclude this variable** due clear faluts in data collection. 

![34auser_temp](https://user-images.githubusercontent.com/43357858/109320067-e5516b80-784f-11eb-92ab-866f9c887baa.jpg)

There we no missing data for temperature.

There does not seem to be any strong correlation between temperature and the targets. 

![12AUSER_corr_temp](https://user-images.githubusercontent.com/43357858/109395488-f7eda280-792c-11eb-99c6-9d1bc37b0746.jpg)

#### Rainfall 

We checked for outliers in precipitation variables - they present long upper tails outisde of the quartile range. 

![24auser_rain](https://user-images.githubusercontent.com/43357858/109319169-da4a0b80-784e-11eb-8279-4311dbc383af.jpg)

We visualised correlations between targets and meteorological features: temperature and rainfall. The differentiation between Northern and Southern wells is also clear here. 

We enriched the variables by retrieving data from [3bmeteo.com](https://www.3bmeteo.com/meteo/ora/storico). 

![29auser_rain_missing2](https://user-images.githubusercontent.com/43357858/109395529-279caa80-792d-11eb-8f3e-084670396cc1.jpg)

#### Hydrometry 

The few missing values present were imputed by calculating the moving average. 

![30auser_Hydrometry](https://user-images.githubusercontent.com/43357858/109395539-32efd600-792d-11eb-9ddd-4b1542a86c4d.jpg)

#### Volume

The values are negative because these features reflect the volumes of water *extracted* from the well. 

![35auser_volumi](https://user-images.githubusercontent.com/43357858/109395548-3aaf7a80-792d-11eb-90cf-4ddd50cad857.jpg)

### Correlation Matrix 

We correlated all variables with one another, before proceeding with feature engineering. As expected, rainfall and temperature variables correlated strongly between and within each other. 

We considered excluding **CC1 and CSA** volume variables and choose CC2 and CSAL for the **greater variance**. 

**Hydrometry (Piaggione)** is strongly correlated with the others, so we decided to **exclude** it. 

![33auser_correlazione](https://user-images.githubusercontent.com/43357858/109321783-d9ff3f80-7851-11eb-88c9-3d08aa297adc.jpg)

### Feature engineering 

We engineered seasons, presence/absence of snow, new threshold for minimum rainfall and time lags as new features to input in the model. 

Distribution of target variables over the seasons does not change much for LT2 well. For CoS and SAL wells are deeper during the summer and in autumn (absolute value).

![37auser_season_target](https://user-images.githubusercontent.com/43357858/109395558-4602a600-792d-11eb-9c62-aee369df9e9f.jpg)

Minimum rainfall levels were set at 0.5 mm, 1.5 mm, 3 mm and 5 mm and time lags were set at +1, +3, +5 and +7 days.  

------------------------------------------------------

**Back to:** 

[**Top**](#top) | [**Aquifers**](#aquifers)

## 2. Water Springs
{: #springs}

### 2.1 Lupa
{: #lupa}

Lupa water spring presents one target variable, flow rate (L/s), and one feature: rainfall. 

We had a first look at the distribution of the target variable over time. 

![first_look](https://user-images.githubusercontent.com/43357858/108836473-2720ae80-75d1-11eb-97e0-6611db32616e.jpg)

This water spring presents a particular anomaly from 2010 until 2020: a constant decreasing linear trend. Only before 2010 and from the beginning of 2020 there is a change in trend. This behaviour looks extremely artificial and unnatural, and for this reason we decided **not to continue analysing this dataset**. At least not until better data is collected.

### 2.2 Madonna di Canneto
{: #canneto}

Madonna di Canneto presented few variables, 3 features (two meteorological and time) and Flow Rate (L/s) as target. 

From the first look at the percentage of missing data, we noticed that the target variable presented the largest % of missing variables. 

```
# A tibble: 4 x 3
  variable                     n_miss pct_miss
  <chr>                         <int>    <dbl>
1 Flow_Rate_Madonna_di_Canneto   1726   55.4  
2 Rainfall_Settefrati             556   17.9  
3 Temperature_Settefrati          556   17.9  
```

We then observed the distribution of the target variable over time to visualise where missing values were **located**.

![first_look_target_canneto](https://user-images.githubusercontent.com/43357858/108752197-73251200-7543-11eb-99e4-53a7b49c0ab4.jpg)

Effectively, the major gap in data was located in the earlier years available in the dataset, including a large gap throughout 2015. We opted to filter the dataset from the beginning of 2016 to proceed with our analyses. 

Even after removing the first gaps, the target variable still presented major areas of missing values, as shown in the image below. We proceeded with imputing the missing values with the moving average (*imputeTS* package).

![na_dist_cannetof](https://user-images.githubusercontent.com/43357858/108750159-fe50d880-7540-11eb-9b7d-d0f9e9a0aeca.jpg)

Also the features presented gaps after filtering out the dataset until 2016, which we enriched with data retrieved from [3bmeteo archive, location: Settefrati](https://www.3bmeteo.com/meteo/settefrati/storico).

So we could finally see both meteorological values in their full and continuous distribution over time. 

![panel_meteo_canneto](https://user-images.githubusercontent.com/43357858/108750164-fee96f00-7540-11eb-9fd0-ddc690ec8dd1.jpg)

Finally, we checked for outliers and found none neither in the target nor in the temperature variable. For precipitation we decided not to modify them as they were many and scattered throughout the dataset, and not showing any particularly odd behaviour. 

#### Feature Engineering 

In terms of feature engineering, after calculating mean weekly rainfall values, we decided to set the new minimum threshold values at 0.8mm, 1.5mm, 2.8mm and 4.4mm. 

```
# summary of mean weekly rainfall values
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.0000  0.7607  2.7857  4.3265  5.8893 29.3714 
```

![panelled_rain](https://user-images.githubusercontent.com/43357858/108883045-45080680-7605-11eb-99aa-c096ed7ed960.jpg)

The Aikaike Information Criteria (AIC) suggested the best number of lags to be of 8 days, and so we added this new feature to each new timeseries.

------------------------------------------------------

**Back to:** 

[**Top**](#top) | [**Water Springs**](#springs)

## 3. River Arno 
{: #arno}

River Arno consisted of many feature variables collected by monitors which ran from the source of the river down to the valley. 

We first had an initial look at the dataset at our disposal and we noticed straight away a large gap of data in the earliest  and also in the latest years, particularly for rainfall variables and for temperature measured in Florence.

![01River_Arno_Inizio](https://user-images.githubusercontent.com/43357858/109392231-442fe700-791b-11eb-958b-cf847e7e7138.jpg)

Here we present a more detailed quantification of missing values, after filtering out the early years with the gap. 

```
# A tibble: 17 x 3
variable                     n_miss      pct_miss
  <chr>                      <int>        <dbl>
1 Rainfall_Stia               4743         78.7
2 Rainfall_Consuma            4743         78.7
3 Rainfall_S_Savino           4743         78.7
4 Rainfall_Laterina           4743         78.7
5 Rainfall_Camaldoli          4743         78.7
6 Rainfall_Montevarchi        4379         72.7
7 Rainfall_Bibbiena           3648         60.5
8 Rainfall_Vernio             1743         28.9
9 Rainfall_Incisa             1458         24.2
10 Temperature_Firenze        1082         18.0
11 Hydrometry_Nave_di_Rosano    3          0.05
```

### Target variable: hydrometry 

Concerning the target variable, **hydrometry (m)**, we found few missing data scattered throughout the timeseries, which we imputed with the moving average. 

![13Hydrometry_Nave_di_Rosano_missing](https://user-images.githubusercontent.com/43357858/109392273-85c09200-791b-11eb-9bfd-63809397bd83.jpg)

Hydrometry represents the level of the subterrean waters monitored from the hydrometric station. 

Observing the graphs, we noticed its seasonal behaviour, with the highest peaks showing between Novermber and May. There are some sudden drops at 0, as of drought, which straight away go back to the seasonal trend. 

### Feature variables: rainfall and temperature 

#### Temperature 

Temperature measured around Florence area is the only variable available for this meteorological feature. It is characterised by its typical seasonal variations, and the majority of its values lies between 0 and 30 degrees C, in line with typical central-Italy values. 

This graph shows the distribution of missing data in the **temperature** variable (Florence).

![12Temperature_Firenze_missing](https://user-images.githubusercontent.com/43357858/109392286-907b2700-791b-11eb-8679-2075caa92827.jpg)

#### Rainfall

It was 9 localities, in particular, which presented very large gaps in the latest years, up to 2020, for **rainfall**.

![11_1All_rain_missing](https://user-images.githubusercontent.com/43357858/109392300-9cff7f80-791b-11eb-8795-0353027f8dbc.jpg)

While **only 5 localities out of 14** had no missing data. 

![11_2All_rain_NOmissing](https://user-images.githubusercontent.com/43357858/109392304-a38df700-791b-11eb-9c5c-24093c2f87d6.jpg)

We **could not have used these variables as they were**, so we enriched and filled all the gaps by retrieving data from [3bmeteo.com](https://www.3bmeteo.com/meteo/ora/storico), **from 2011 until 2020**.

Even then, there were data that we could not access, for the years previous 2011. We thus decided to further **filter out** data up to 2011, before being able to continue.

![14River_Arno_cut_fewmissing](https://user-images.githubusercontent.com/43357858/109392309-ab4d9b80-791b-11eb-94d6-c90c51166a38.jpg)

### Feature selection 

We started doing some feature selection, to prepare the dataset for modelling. 

As we assumed, most rainfall variables were strongly and positively correlated with one another, while, on the opposite, rainfall and temperature variables were strongly and negatively correlated. Hydrometry is inversely correlated to temperature. 

We noticed that rainfall variables could be subdivided into two groups: one containing 6 of the variables whose geographical location is found where the major river's affluent, the Silve river, runs. In the second group, we found the remaining 8 variables, located from the source of the river. Most interestingly, we noticed that the variables **within the group were strongly correlated with one another**, while **poorly correlated between groups**. 

Thus, we decided to input few representatives from each group into the final model.

![17Correlation_matrix](https://user-images.githubusercontent.com/43357858/109143545-7517ec80-7760-11eb-9428-c0f111f974d1.jpg)

### Feature engineering 

We added seasons as features and observed how target values were distributed by season. From this, we could infer that **seasons** explained little of the target variable - few variations in the median were observed in spring and winter, but neglectable. 

![21target+seasons](https://user-images.githubusercontent.com/43357858/109392345-ddf79400-791b-11eb-9550-640523dc7f18.jpg)

We then set new minimum thresholds of rainfall at 0.5 mm, 1.5 mm, 3 mm and 5 mm, and we added time lags based on the distance from the pluviometric sensors to the hydrometric sensor. 

We divided the localities in three groups. 

For the first group (Incisa, Consuma, Montevarchi, S. Plero), we did not add a lag, as the sensors were less than 50 km distant. 

For the second group (Laterina, S. Agata, Le Croci, Cavallina, Mangona) we added a time lag of 1 day, as they are up to 100 km distant. 

For localities at a greater distance than 100 km (Stia, Camaldoli, Bibbiena, S. Avinro, Vernio) we added a 2-day time lag. 

------------------------------------------------------

**Back to:** 

[**Top**](#top) | [**River Arno**](#arno)

## 4. Lake Bilancino
{: #bilancino}

Lake Bilancino is an **artifical waterbody** in the Muggello area, encountering the Sieve river (both inlet and outlet). 

Lake Bilancino presents five rainfall variables and one temperature variables as features, and two targets: **lake level (m)** and **flow rate (L/s)**. 

We first observed presence of missing data and decided to filter out the dataset up until the end of 2003. 

![01Bilancino_Inizio](https://user-images.githubusercontent.com/43357858/109392487-8efe2e80-791c-11eb-9f24-b05f257ea888.jpg)

### Target variables: flow rate and lake level 

**Mean flow rate** is very low: **2.78 L/s**. Sometimes it presents very strong and sudden peaks, soon returing back to a more constant trend. **Lake level** has very low variability, with a constant range **between 243 m and 253 m** over more than 16 years. 

![05Bilancino_target](https://user-images.githubusercontent.com/43357858/109392492-96bdd300-791c-11eb-953f-110fe4407d7b.jpg)

We observed distribution of target variables and decided to keep the outliers as they are considering that, being an artificial lake, flux alterations must have not been stochastic. 

![09box_target](https://user-images.githubusercontent.com/43357858/109392500-9de4e100-791c-11eb-837b-b7bd7283169f.jpg)

### Features: meteorological 

The 5 different rainfall variables range between 0 mm and 125 mm. 

![10Bilancino_rain](https://user-images.githubusercontent.com/43357858/109392520-c240bd80-791c-11eb-8624-402a37601761.jpg)

Mean temperature value is of 15 째C, it is seasonal and typical of central Italy, ranging mainly between 0 째C and 30 째C. 

![12Bilancino_temp](https://user-images.githubusercontent.com/43357858/109392523-c8cf3500-791c-11eb-8235-477efde7324c.jpg)


### Feature selection and engineering 

Rainfall variables are strongly correlated to one another, as expected. We decided to keep **3 of them for modelling**: S. Piero, Mangona and Cavallina localities, as these are least correlated to one another. We kept temperature there being only one variable as representative. 

![11Bilancino_correlazione](https://user-images.githubusercontent.com/43357858/109392543-e00e2280-791c-11eb-8eaf-f8ddf526dbd6.jpg)

We looked at correlations between rainfall and lake level, and found **inverse relationship**. Lake levels **fall** particularly at **end of the year**, rising again in January after the rains: we can conclude **there must be a lag of a few months for the water level to recharge**. 

![13Bilancino_LL_rainfall](https://user-images.githubusercontent.com/43357858/109392542-dbe20500-791c-11eb-93e1-13eacc9b8aed.jpg)

We carried out feature engineering and added seasons, presence/absence of snow, rainfall thresholds and time lags (+1, +3, +5, +7 days).

We looked at the distribution of the target variables over the seasons, and found that lake level is lowest during autumn, while highest in the spring. For flow rate there isn't much of difference between seasons. Outliers are present particularly in spring and autumn, but we did not do any modifications to them. 

![06Bilancino_target_season](https://user-images.githubusercontent.com/43357858/109392548-f1572f00-791c-11eb-8e2b-f5c8d59429f7.jpg)

------------------------------------------------------

&nbsp;

Back to: 

[**Top**](#top) | [**Lake Bilancino**](#bilancino) 

&nbsp;
