# 1. Data Cleaning and Feature Engineering

## 1.1 Aquifers

### 1.1.1 Doganella 

Doganella has 9 target variables for each well which characterises the aquifer, all representing depth to groundwater (m).

First observations of the target variables is the large gap of missing data in the early years of the dataset. In fact, around **60% is missing**. 

Not only the target variables, but also their features present a large percentage of missing values. In particular, volumes lack 70% of their values, followed by 30% of temperature values and 10% of rainfall values. 

For this reason, we decided to filter out the dataset for the largest gap present in well 1 (77.5%).

The largest portion remaining of missing data was found in meteorological and target variables. 

```
# A tibble: 15 x 3
   variable                n_miss pct_miss
   <chr>                    <int>    <dbl>
 1 Temperature Monteporzio   7245   59.1  
 2 Temperature Velletri      7236   59.0  
 3 Rainfall Monteporzio      3186   26.0  
 4 Rainfall Velletri         2430   19.8  
 5 Depth to groundwater      2329   19.0  
```
We first imputed the missing target values by substituting them with their dynamic average. 

![imp_vis](https://user-images.githubusercontent.com/43357858/108858042-04e85a00-75ec-11eb-9592-c3fd503832e1.jpg)

We did the same for volume variables.

![imp_volumes](https://user-images.githubusercontent.com/43357858/108858046-06198700-75ec-11eb-881e-ffd7d2e9caf3.jpg)

Then, we enriched meteorological data by integrating them with data we found and retrieved from [3bmeteo.com/Velletri](3bmeteo.com/meteo/velletri/storico) and [3bmeteo.com/Monteporzio](https://www.3bmeteo.com/meteo/monte+porzio+catone/storico).

#### Outliers 

We looked at the frequency distribution of the target variables by creating boxplots. 

![boxplot_target](https://user-images.githubusercontent.com/43357858/108859183-3f9ec200-75ed-11eb-8701-de6fff7265f4.jpg)

We decided to substitute the largest outlier found in wells 2 and 8 with their respective value at Q3. We decided not to modify the remaining outliers as they were many and scattered throughout the timeseries.  

## 1.2 Water Springs

### 1.2.1 Lupa

Lupa water spring presents one target variable, flow rate (L/s), and one feature: rainfall. 

We had a first look at the distribution of the target variable over time. 

![first_look](https://user-images.githubusercontent.com/43357858/108836473-2720ae80-75d1-11eb-97e0-6611db32616e.jpg)

This water spring presents a particular anomaly from 2010 until 2020: a constant decreasing linear trend. Only before 2010 and from the beginning of 2020 there is a change in trend. This behaviour looks extremely artificial and unnatural, and for this reason we decided **not to continue analysing this dataset**. At least not until better data is collected.




### 1.2.2 Madonna di Canneto

Madonna di Canneto presented few variables, 3 features (two meteorological and time) and Flow Rate (L/s) as target. 

From the first look at the percentage of missing data, we noticed that the target variable presented the largest % of missing variables. 

```
# A tibble: 4 x 3
  variable                     n_miss pct_miss
  <chr>                         <int>    <dbl>
1 Flow_Rate_Madonna_di_Canneto   1726   55.4  
2 Rainfall_Settefrati             556   17.9  
3 Temperature_Settefrati          556   17.9  
```

We then observed the distribution of the target variable over time to visualise where missing values were **located**.

![first_look_target_canneto](https://user-images.githubusercontent.com/43357858/108752197-73251200-7543-11eb-99e4-53a7b49c0ab4.jpg)

Effectively, the major gap in data was located in the earlier years available in the dataset, including a large gap throughout 2015. We opted to filter the dataset from the beginning of 2016 to proceed with our analyses. 

Even after removing the first gaps, the target variable still presented major areas of missing values, as shown in the image below. We proceeded with imputing the missing values with the moving average (*imputeTS* package).

![na_dist_cannetof](https://user-images.githubusercontent.com/43357858/108750159-fe50d880-7540-11eb-9b7d-d0f9e9a0aeca.jpg)

Also the features presented gaps after filtering out the dataset until 2016, which we enriched with data retrieved from [3bmeteo archive, location: Settefrati](https://www.3bmeteo.com/meteo/settefrati/storico).

So we could finally see both meteorological values in their full and continuous distribution over time. 

![panel_meteo_canneto](https://user-images.githubusercontent.com/43357858/108750164-fee96f00-7540-11eb-9fd0-ddc690ec8dd1.jpg)

Finally, we checked for outliers and found none neither in the target nor in the temperature variable. For precipitation we decided not to modify them as they were many and scattered throughout the dataset, and not showing any particularly odd behaviour. 

#### Feature Engineering 

In terms of feature engineering, after calculating mean weekly rainfall values, we decided to set the new minimum threshold values at 0.8mm, 1.5mm, 2.8mm and 4.4mm. 

```
# summary of mean weekly rainfall values
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.0000  0.7607  2.7857  4.3265  5.8893 29.3714 
```

![panelled_rain](https://user-images.githubusercontent.com/43357858/108820544-9f30a980-75bc-11eb-959a-3c833eba0291.jpg)

The Aikaike Information Criteria (AIC) suggested the best number of lags to be of 8 days, and so we added this new feature to each new timeseries.

------------------------------

## 1.3 River 

## 1.4 Lake