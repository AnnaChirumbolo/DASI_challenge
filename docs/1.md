# Data Cleaning and Feature Engineering

## 1.1 Aquifers

### 1.1.1 Doganella 

Doganella has 9 target variables for each well which characterises the aquifer, all representing depth to groundwater (m).

First observations of the target variables is the large gap of missing data in the early years of the dataset. In fact, around **60% is missing**. 

Not only the target variables, but also their features present a large percentage of missing values. In particular, volumes lack 70% of their values, followed by 30% of temperature values and 10% of rainfall values. 

For this reason, we decided to filter out the dataset for the largest gap present in well 1 (77.5%).

The largest portion remaining of missing data was found in meteorological and target variables. 

```
# A tibble: 15 x 3
   variable                n_miss pct_miss
   <chr>                    <int>    <dbl>
 1 Temperature Monteporzio   7245   59.1  
 2 Temperature Velletri      7236   59.0  
 3 Rainfall Monteporzio      3186   26.0  
 4 Rainfall Velletri         2430   19.8  
 5 Depth to groundwater      2329   19.0  
```
We first imputed the missing target values by substituting them with their dynamic average. 

![imp_vis](https://user-images.githubusercontent.com/43357858/108858042-04e85a00-75ec-11eb-9592-c3fd503832e1.jpg)

We did the same for volume variables.

![imp_volumes](https://user-images.githubusercontent.com/43357858/108874213-3bc66c00-75fc-11eb-9d1f-769f9e4564f4.jpg)

Then, we enriched meteorological data by integrating them with data we found and retrieved from [3bmeteo.com/Velletri](3bmeteo.com/meteo/velletri/storico) and [3bmeteo.com/Monteporzio](https://www.3bmeteo.com/meteo/monte+porzio+catone/storico).

![panel_meteo](https://user-images.githubusercontent.com/43357858/108879215-54855080-7601-11eb-8ef5-3ce2250fe41b.jpg)

#### Outliers 

We looked at the frequency distribution of the target variables by creating boxplots. 

![boxplot_target](https://user-images.githubusercontent.com/43357858/108859183-3f9ec200-75ed-11eb-8701-de6fff7265f4.jpg)

We decided to substitute the largest outlier found in wells 2 and 8 with their respective value at Q3. We decided not to modify the remaining outliers as they were many and scattered throughout the timeseries.  

## 1.2 Water Springs

### 1.2.1 Lupa

Lupa water spring presents one target variable, flow rate (L/s), and one feature: rainfall. 

We had a first look at the distribution of the target variable over time. 

![first_look](https://user-images.githubusercontent.com/43357858/108836473-2720ae80-75d1-11eb-97e0-6611db32616e.jpg)

This water spring presents a particular anomaly from 2010 until 2020: a constant decreasing linear trend. Only before 2010 and from the beginning of 2020 there is a change in trend. This behaviour looks extremely artificial and unnatural, and for this reason we decided **not to continue analysing this dataset**. At least not until better data is collected.




### 1.2.2 Madonna di Canneto

Madonna di Canneto presented few variables, 3 features (two meteorological and time) and Flow Rate (L/s) as target. 

From the first look at the percentage of missing data, we noticed that the target variable presented the largest % of missing variables. 

```
# A tibble: 4 x 3
  variable                     n_miss pct_miss
  <chr>                         <int>    <dbl>
1 Flow_Rate_Madonna_di_Canneto   1726   55.4  
2 Rainfall_Settefrati             556   17.9  
3 Temperature_Settefrati          556   17.9  
```

We then observed the distribution of the target variable over time to visualise where missing values were **located**.

![first_look_target_canneto](https://user-images.githubusercontent.com/43357858/108752197-73251200-7543-11eb-99e4-53a7b49c0ab4.jpg)

Effectively, the major gap in data was located in the earlier years available in the dataset, including a large gap throughout 2015. We opted to filter the dataset from the beginning of 2016 to proceed with our analyses. 

Even after removing the first gaps, the target variable still presented major areas of missing values, as shown in the image below. We proceeded with imputing the missing values with the moving average (*imputeTS* package).

![na_dist_cannetof](https://user-images.githubusercontent.com/43357858/108750159-fe50d880-7540-11eb-9b7d-d0f9e9a0aeca.jpg)

Also the features presented gaps after filtering out the dataset until 2016, which we enriched with data retrieved from [3bmeteo archive, location: Settefrati](https://www.3bmeteo.com/meteo/settefrati/storico).

So we could finally see both meteorological values in their full and continuous distribution over time. 

![panel_meteo_canneto](https://user-images.githubusercontent.com/43357858/108750164-fee96f00-7540-11eb-9fd0-ddc690ec8dd1.jpg)

Finally, we checked for outliers and found none neither in the target nor in the temperature variable. For precipitation we decided not to modify them as they were many and scattered throughout the dataset, and not showing any particularly odd behaviour. 

#### Feature Engineering 

In terms of feature engineering, after calculating mean weekly rainfall values, we decided to set the new minimum threshold values at 0.8mm, 1.5mm, 2.8mm and 4.4mm. 

```
# summary of mean weekly rainfall values
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.0000  0.7607  2.7857  4.3265  5.8893 29.3714 
```

![panelled_rain](https://user-images.githubusercontent.com/43357858/108883045-45080680-7605-11eb-99aa-c096ed7ed960.jpg)

The Aikaike Information Criteria (AIC) suggested the best number of lags to be of 8 days, and so we added this new feature to each new timeseries.

------------------------------

## 1.3 River Arno 

River Arno consisted of many feature variables collected by monitors which ran from the source of the river down to the valley. 

We first had an initial look at the dataset at our disposal and we noticed straight away a large gap of data in the earliest  and also in the latest years, particularly for rainfall variables and for temperature measured in Florence.

![01River_Arno_Inizio](https://user-images.githubusercontent.com/43357858/109138759-01271580-775b-11eb-92ab-ab9f2b44ef17.jpg)

Here we present a more detailed quantification of missing values, after filtering out the early years with the gap. 

```
# A tibble: 17 x 3
variable                     n_miss      pct_miss
  <chr>                      <int>        <dbl>
1 Rainfall_Stia               4743         78.7
2 Rainfall_Consuma            4743         78.7
3 Rainfall_S_Savino           4743         78.7
4 Rainfall_Laterina           4743         78.7
5 Rainfall_Camaldoli          4743         78.7
6 Rainfall_Montevarchi        4379         72.7
7 Rainfall_Bibbiena           3648         60.5
8 Rainfall_Vernio             1743         28.9
9 Rainfall_Incisa             1458         24.2
10 Temperature_Firenze        1082         18.0
11 Hydrometry_Nave_di_Rosano    3          0.05
```

### Target variable: hydrometry 

Concerning the target variable, **hydrometry (m)**, we found few missing data scattered throughout the timeseries, which we imputed with the moving average. 

![13Hydrometry_Nave_di_Rosano_missing](https://user-images.githubusercontent.com/43357858/109140966-74318b80-775d-11eb-8472-d1fede79176e.jpg)

Hydrometry represents the level of the subterrean waters monitored from the hydrometric station. 

Observing the graphs, we noticed its seasonal behaviour, with the highest peaks showing between Novermber and May. There are some sudden drops at 0, as of drought, which straight away go back to the seasonal trend. 

### Feature variables: rainfall and temperature 

#### Temperature 

Temperature measured around Florence area is the only variable available for this meteorological feature. It is characterised by its typical seasonal variations, and the majority of its values lies between 0 and 30 degrees C, in line with typical central-Italy values. 

This graph shows the distribution of missing data in the **temperature** variable (Florence).

![12Temperature_Firenze_missing](https://user-images.githubusercontent.com/43357858/109140024-7810de00-775c-11eb-9555-f2df1b2ceb94.jpg)
#### Rainfall

It was 9 localities, in particular, which presented very large gaps in the latest years, up to 2020, for **rainfall**.

![11_1All_rain_missing](https://user-images.githubusercontent.com/43357858/109139736-236d6300-775c-11eb-90cd-eea85e153ac7.jpg)

While **only 5 localities out of 14** had no missing data. 

![11_2All_rain_NOmissing](https://user-images.githubusercontent.com/43357858/109139867-4a2b9980-775c-11eb-9516-51c150e9d4de.jpg)

We **could not have used these variables as they were**, so we enriched and filled all the gaps by retrieving data from [3bmeteo.com](https://www.3bmeteo.com/meteo/ora/storico), **from 2011 until 2020**.

Even then, there were data that we could not access, for the years previous 2011. We thus decided to further **filter out** data up to 2011, before being able to continue.

![14River_Arno_cut_fewmissing](https://user-images.githubusercontent.com/43357858/109141092-9f1bdf80-775d-11eb-9938-407150a5ebf1.jpg)

### Feature selection 

We started doing some feature selection, to prepare the dataset for modelling. 

As we assumed, most rainfall variables were strongly and positively correlated with one another, while, on the opposite, rainfall and temperature variables were strongly and negatively correlated. Hydrometry is inversely correlated to temperature. 

We noticed that rainfall variables could be subdivided into two groups: one containing 6 of the variables whose geographical location is found where the major river's affluent, the Silve river, runs. In the second group, we found the remaining 8 variables, located from the source of the river. Most interestingly, we noticed that the variables **within the group were strongly correlated with one another**, while **poorly correlated between groups**. 

Thus, we decided to input few representatives from each group into the final model.

![17Correlation_matrix](https://user-images.githubusercontent.com/43357858/109143545-7517ec80-7760-11eb-9428-c0f111f974d1.jpg)

### Feature engineering 

We added seasons as features and observed how target values were distributed by season. From this, we could infer that **seasons** explained little of the target variable - few variations in the median were observed in spring and winter, but neglectable. 

![21target+seasons](https://user-images.githubusercontent.com/43357858/109145425-c32def80-7762-11eb-8124-d8b951cdeec9.jpg)

We then set new minimum thresholds of rainfall at 0.5 mm, 1.5 mm, 3 mm and 5 mm, and we added time lags based on the distance from the pluviometric sensors to the hydrometric sensor. 

We divided the localities in three groups. 

For the first group (Incisa, Consuma, Montevarchi, S. Plero), we did not add a lag, as the sensors were less than 50 km distant. 

For the second group (Laterina, S. Agata, Le Croci, Cavallina, Mangona) we added a time lag of 1 day, as they are up to 100 km distant. 

For localities at a greater distance than 100 km (Stia, Camaldoli, Bibbiena, S. Avinro, Vernio) we added a 2-day time lag. 

--------------------------------------------------------

## 1.4 Lake
