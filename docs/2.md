# MODELLING AND FORECASTING
{: #top}

## Waterbodies: 

### [1. Aquifers](#aquifers)

##### [1.1 Doganella](#doganella)

##### [1.2 Luco](#luco)

##### [1.3 Auser](#auser)

### [2. Water Springs](#springs)

#### [2.1 Lupa](#lupa)

#### [2.2 Madonna di Canneto](#canneto)

### [3. River Arno](#arno)

### [4. Lake Bilancino](#bilancino)

------------------------------------------------

## 1. Aquifers
{: #aquifers}

### 1.1 Doganella 
{: #doganella}

#### Choosing the best model 

After performing autoML on all datasets of Doganella (original and featured), **GBM** resulted to be the best regression model, also outperforming timeseries models. 

![automl](https://user-images.githubusercontent.com/43357858/109181335-19fbef00-778c-11eb-970d-1bf53a9c1d43.png)

#### Model results 

##### [Top](#top)

### 1.2 Luco 
{: #luco}

#### Choosing the best model 

We prepared a pipeline test on RapidMiner to compare ML and DL models for both target variables. 

For well 1 we found Gradient Boost Machine to be the best performing model (smallest RMSE: 0.16). This was also confirmed by the other autoML model run on R. 

![RM_Luco_imp1](https://user-images.githubusercontent.com/43357858/109385711-2d2ace00-78f6-11eb-800e-d6dc7ba5b691.png)

Also for well 3 we found Gradient Boost Machine as the best performing model (RMSE: 0.32). This was confirmed by the autoML test run on R. 

![RM_Luco_imp3](https://user-images.githubusercontent.com/43357858/109385714-2ef49180-78f6-11eb-965c-98ae1ea8ffee.png)

#### Gradient Boost Machine 

##### Target 1 (well 1): depth to groundwater (m)

From our GBM run on R, we obtained an **RMSE of 0.14**, with volume being the most influential feature on the target variable, followed by temperature. 

![FI_imp1](https://user-images.githubusercontent.com/43357858/109385787-afb38d80-78f6-11eb-9604-b1be4d1af044.jpeg)

And the following graph between predicted and actual target values. 

![RM_Luco_imp1_PC](https://user-images.githubusercontent.com/43357858/109385790-b17d5100-78f6-11eb-8199-73e14204d843.png)

##### Target 2 (well 3): depth to groundwater (m)

From our GBM we obtained **RMSE: 0.25**, with volume as the most influential variable on the target, followed, again by temperature. 

![FI_imp3](https://user-images.githubusercontent.com/43357858/109385789-b0e4ba80-78f6-11eb-8860-0239fcd2ddf0.jpeg)

And the following graph correlating predicted with actual target values. 

![RM_Luco_imp3_PC](https://user-images.githubusercontent.com/43357858/109385791-b215e780-78f6-11eb-9aa5-9631ca477ecf.png)

# bisogno del r2!!!

##### [Top](#top)

### 1.3 Auser 
{: #auser}

From our autoML and RapdMiner tests, Random Forest and Gradient Boost Machine resulted to be the best performing models. 

#### Random Forest 

##### Target 1: CoS

PAG well seems to have the largest influence on the target, followed by POL volume. Rainfall variables have the least influence. RMSE: 0.22

![40auser_RF_cos](https://user-images.githubusercontent.com/43357858/109322978-3adb4780-7853-11eb-90f2-1333a359c5a3.jpg)

##### Target 2: LT2 

CSAL well has the largest influence on the target, rainfall has again little importance. RMSE: 0.07

![41auser_RF_LT2](https://user-images.githubusercontent.com/43357858/109323134-69f1b900-7853-11eb-8628-5e1a61bcb6df.jpg)

##### Target 3: SAL

DIEC well has the largest impact in the model, **3 times greater** than the second most important feature: PAG well. Rainfall has the least influence in the model over the target. RMSE: 0.1

![42auser_RF_SAL](https://user-images.githubusercontent.com/43357858/109323317-a1606580-7853-11eb-8ff4-947e1d8f1964.jpg)

#### Gradient Boost Machine 

##### Target 1: CoS 

**RMSE: 0.22**

![44auser_pozzocos_features](https://user-images.githubusercontent.com/43357858/109323948-52ff9680-7854-11eb-9bf0-992f3348a8e7.jpg)

##### Target 2: LT2 

**RMSE: 0.09**

![47auser_pozzolt2_features](https://user-images.githubusercontent.com/43357858/109323997-63b00c80-7854-11eb-811e-f06a3484ac31.jpg)

##### Target 2: SAL

**RMSE: 0.11**

![50auser_pozzosal_features](https://user-images.githubusercontent.com/43357858/109324168-95c16e80-7854-11eb-9aae-fa4ecabea7ee.jpg)

------------------------------------------------------

<div align="center">

Back to: 

[**Top**](#top) | [**Aquifers**](#aquifers)

</div>

------------------------------------------------------

## 2. Water Springs
{: #springs}

### 2.1 Madonna di Canneto
{: #canneto}

#### Choosing the best model

After performing autoML on all datasets of Madonna di Canneto (original and featured), **GBM** resulted to be the best regression model. This coincided with a check we did on RapidMiner.

  ![varimp h2o jpg](https://user-images.githubusercontent.com/43357858/108821918-9d67e580-75be-11eb-82ec-276d1e28cbe2.png)

Instead, after performing autoTS we found tbats to be the best performance as timeseries model.

```
# Comparison of TS model errors (RMSE)
  prophet   ets sarima tbats  bats  stlm shortterm bagged
    <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl>     <dbl>  <dbl>
1    32.9  2.58   7.64  1.27  2.54  6.08      2.76   3.59
```

![autoTS_res jpg](https://user-images.githubusercontent.com/43357858/108823840-431c5400-75c1-11eb-99e0-e8cb8dd83e10.png)

We also plotted predicted vs actual values for tbats.

![tbats](https://user-images.githubusercontent.com/43357858/108824227-c76ed700-75c1-11eb-90ab-e921b2c10269.jpg)

From the plot above we decided not to use tbats, but just to continue with gbm. 

#### Model results 

##### Gradient Boost Machine 

We compared GBM error results between the five different timeseries with changing thresholds, and concluded that the best fit was for the original timseries, with no changes to the minimum rainfall values. 

We then compared RMSE results between the original timeseries and all its features, and the original timseries with feature selection made with stepwise regression. The former GBM model resulted in an RMSE of 26.05 L/s, while the latter resulted in 25.97 L/s. We thus chose the second model. 

The following graph shows the relationship between predicted and actual target values of the best model. 

![gbm_act_pred](https://user-images.githubusercontent.com/43357858/108829952-179d6780-75c9-11eb-8271-834b9b4456b1.jpg)

The model showed that temperature has the greatest influence over flow rate (50%), followed by the 8-day time lag of rainfall. 

![rel_infl gbm](https://user-images.githubusercontent.com/43357858/108829984-1f5d0c00-75c9-11eb-9920-d2bbc18bc9cc.jpg)

------------------------------------------------------

<div align="center">

Back to: 

[**Top**](#top) | [**Water Springs**](#springs)

</div>

------------------------------------------------------

## 3. River Arno
{: #arno}

### Model selection 

We carried out Random Forest and Gradient Boost Machine tests, especially after carrying out test with autoML packages and RapidMiner.

```
# Comparing model errors

    RandomForest                 RMSE                 
test 1 (Le Croci/Stia)           0.48
test 2 (Cavallina/Bibbiena)      0.48
test 3 (lags)                    0.37

    Gradient Boost Machine       RMSE
test 1 (lags)                    0.34
```

### Modelling and Forecasting 

#### Random Forest 

The best RF model was number 3, with the added time lag variables. 

![25RF_LAG_037](https://user-images.githubusercontent.com/43357858/109146846-9b3f8b80-7764-11eb-9e5c-e60628f8b9d6.jpg)

#### Gradient Boost Machine 

The gbm model outperformed all others, also done with RF (RMSE: 0.34).

Here we show the top features with descenting order of relative importance in explaining the target variable. 

![27Variabili_LAG_GB_thebest_03385](https://user-images.githubusercontent.com/43357858/109392410-2b740100-791c-11eb-8076-3a974e77828e.jpg)

Also another test done with Le Croci, Cavallina localities (for the first group), Bibbiena and Stia (for the second group) resulted in a lower RMSE compared to RF results: 0.34. 

Here we shot the top 6 features with descending order of relative importance in explaining the target variable. 

![29Variabili_GB1](https://user-images.githubusercontent.com/43357858/109392414-3169e200-791c-11eb-87c3-e6b87289dfc1.jpg)

------------------------------------------------------

<div align="center">

Back to: 

[**Top**](#top) | [**River Arno**](#arno)

</div>

------------------------------------------------------

## 4. Lake Bilancino 
{: #bilancino}

From autoML and RapidMiner test for choice of model, we found that Random Forest and Gradient Boost Machine reflected the best fit. 

### Random Forest 

#### Target 1: Lake Level 

**RMSE: 1.78, 33% variance. **

Autumn has the greatest influence in the model over the target variable (as seen in the boxplot, when comparing seasons), 3 times greater than spring - the second most influential feature in the model. 

Rainfall variables seem to have the least influence on the target. 

![16Bilancino_RF_LL](https://user-images.githubusercontent.com/43357858/109328262-8d1f6700-7859-11eb-84a0-2306bc223f03.jpg)

![17_0lake_level_pred](https://user-images.githubusercontent.com/43357858/109392776-434c8480-791e-11eb-8511-52b388d434a7.jpg)

#### Target 2: Flow Rate 

**RMSE: 4.22, 9.9% variance. **

In this case, Rainfall at S. Piero locality and temperature have the greatest influence. 

![18Bilancino_RF_flowrate](https://user-images.githubusercontent.com/43357858/109328482-c48e1380-7859-11eb-893c-6b3a810af870.jpg)

![20_1Bilancino_flowratel_pred_act](https://user-images.githubusercontent.com/43357858/109392812-827ad580-791e-11eb-9df5-da9f395c14b5.jpg)

### Gradient Boost Machine 

#### Target 1: Lake Level 

**RMSE: 1.60**

![25lake_level_features](https://user-images.githubusercontent.com/43357858/109392842-b9e98200-791e-11eb-9e22-ad890e7c51b1.jpg)

![27Bilancino_lakelevel_pred_act](https://user-images.githubusercontent.com/43357858/109392853-c2da5380-791e-11eb-9b81-4713b15903f5.jpg)

#### Target 2: Flow Rate 

**RMSE: 3.42 **

![21flowrate_features](https://user-images.githubusercontent.com/43357858/109392859-ca99f800-791e-11eb-885d-d7c2b53e0bda.jpg)

![23Bilancino_flowrate_pred_act](https://user-images.githubusercontent.com/43357858/109392868-d1286f80-791e-11eb-9d33-957008db3abd.jpg)

------------------------------------------------------

<div align="center">

Back to: 

[**Top**](#top) | [**Lake Bilancino**](#bilancino)

</div>

------------------------------------------------------