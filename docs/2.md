# MODELLING AND FORECASTING

## 2.1 Aquifers

### 2.1.1 Doganella 

#### Choosing the best model 

After performing autoML on all datasets of Doganella (original and featured), **GBM** resulted to be the best regression model, also outperforming timeseries models. 

![automl](https://user-images.githubusercontent.com/43357858/109181335-19fbef00-778c-11eb-970d-1bf53a9c1d43.png)

#### Model results 


### 2.1.2 Auser 

From our autoML and RapdMiner tests, Random Forest and Gradient Boost Machine resulted to be the best performing models. 

#### Random Forest 

##### Target 1: CoS

PAG well seems to have the largest influence on the target, followed by POL volume. Rainfall variables have the least influence. RMSE: 0.22

![40auser_RF_cos](https://user-images.githubusercontent.com/43357858/109322978-3adb4780-7853-11eb-90f2-1333a359c5a3.jpg)

##### Target 2: LT2 

CSAL well has the largest influence on the target, rainfall has again little importance. RMSE: 0.07

![41auser_RF_LT2](https://user-images.githubusercontent.com/43357858/109323134-69f1b900-7853-11eb-8628-5e1a61bcb6df.jpg)

##### Target 3: SAL

DIEC well has the largest impact in the model, **3 times greater** than the second most important feature: PAG well. Rainfall has the least influence in the model over the target. RMSE: 0.1

![42auser_RF_SAL](https://user-images.githubusercontent.com/43357858/109323317-a1606580-7853-11eb-8ff4-947e1d8f1964.jpg)

#### Gradient Boost Machine 

##### Target 1: CoS 

**RMSE: 0.22**

![44auser_pozzocos_features](https://user-images.githubusercontent.com/43357858/109323948-52ff9680-7854-11eb-9bf0-992f3348a8e7.jpg)

##### Target 2: LT2 

RMSE: 0.09

![47auser_pozzolt2_features](https://user-images.githubusercontent.com/43357858/109323997-63b00c80-7854-11eb-811e-f06a3484ac31.jpg)

##### Target 2: SAL

RMSE: 0.11

![50auser_pozzosal_features](https://user-images.githubusercontent.com/43357858/109324168-95c16e80-7854-11eb-9aae-fa4ecabea7ee.jpg)

--------------------------------------------------

## 2.2 Water Springs

### 2.2.1 Madonna di Canneto

#### Choosing the best model

After performing autoML on all datasets of Madonna di Canneto (original and featured), **GBM** resulted to be the best regression model. This coincided with a check we did on RapidMiner.

  ![varimp h2o jpg](https://user-images.githubusercontent.com/43357858/108821918-9d67e580-75be-11eb-82ec-276d1e28cbe2.png)

Instead, after performing autoTS we found tbats to be the best performance as timeseries model.

```
# Comparison of TS model errors (RMSE)
  prophet   ets sarima tbats  bats  stlm shortterm bagged
    <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl>     <dbl>  <dbl>
1    32.9  2.58   7.64  1.27  2.54  6.08      2.76   3.59
```

![autoTS_res jpg](https://user-images.githubusercontent.com/43357858/108823840-431c5400-75c1-11eb-99e0-e8cb8dd83e10.png)

We also plotted predicted vs actual values for tbats.

![tbats](https://user-images.githubusercontent.com/43357858/108824227-c76ed700-75c1-11eb-90ab-e921b2c10269.jpg)

From the plot above we decided not to use tbats, but just to continue with gbm. 

#### Model results 

##### Gradient Boost Machine 

We compared GBM error results between the five different timeseries with changing thresholds, and concluded that the best fit was for the original timseries, with no changes to the minimum rainfall values. 

We then compared RMSE results between the original timeseries and all its features, and the original timseries with feature selection made with stepwise regression. The former GBM model resulted in an RMSE of 26.05 L/s, while the latter resulted in 25.97 L/s. We thus chose the second model. 

The following graph shows the relationship between predicted and actual target values of the best model. 

![gbm_act_pred](https://user-images.githubusercontent.com/43357858/108829952-179d6780-75c9-11eb-8271-834b9b4456b1.jpg)

The model showed that temperature has the greatest influence over flow rate (50%), followed by the 8-day time lag of rainfall. 

![rel_infl gbm](https://user-images.githubusercontent.com/43357858/108829984-1f5d0c00-75c9-11eb-9920-d2bbc18bc9cc.jpg)

----------------------------------------------------

## 2.3 River Arno

### Model selection 

We carried out Random Forest and Gradient Boost Machine tests, especially after carrying out test with autoML packages and RapidMiner.

```
# Comparing model errors

    RandomForest                 RMSE                 
test 1 (Le Croci/Stia)           0.48
test 2 (Cavallina/Bibbiena)      0.48
test 3 (lags)                    0.37

    Gradient Boost Machine       RMSE
test 1 (lags)                    0.34
```

### Modelling and Forecasting 

#### Random Forest 

The best RF model was number 3, with the added time lag variables. 

![25RF_LAG_037](https://user-images.githubusercontent.com/43357858/109146846-9b3f8b80-7764-11eb-9e5c-e60628f8b9d6.jpg)

#### Gradient Boost Machine 

The gbm model outperformed all others, also done with RF (RMSE: 0.34).

Here we show the top features with descenting order of relative importance in explaining the target variable. 

![27](https://user-images.githubusercontent.com/43357858/109147104-ebb6e900-7764-11eb-82a8-79822211d4c0.jpg)

Also another test done with Le Croci, Cavallina localities (for the first group), Bibbiena and Stia (for the second group) resulted in a lower RMSE compared to RF results: 0.34. 

Here we shot the top 6 features with descending order of relative importance in explaining the target variable. 

![29Variabili_GB1_03423](https://user-images.githubusercontent.com/43357858/109147499-5cf69c00-7765-11eb-9ece-c143455c3f9a.jpg)

-----------------------------------------------

## 2.4 Lake Bilancino 

From autoML and RapidMiner test for choice of model, we found that Random Forest and Gradient Boost Machine reflected the best fit. 

### Random Forest 

#### Target 1: Lake Level 

RMSE: 1.78, 33% variance. 

Autumn has the greatest influence in the model over the target variable (as seen in the boxplot, when comparing seasons), 3 times greater than spring - the second most influential feature in the model. 

Rainfall variables seem to have the least influence on the target. 

![16Bilancino_RF_LL](https://user-images.githubusercontent.com/43357858/109328262-8d1f6700-7859-11eb-84a0-2306bc223f03.jpg)

![17Bilancino_RF_LakeLevel](https://user-images.githubusercontent.com/43357858/109328419-b9d37e80-7859-11eb-9f11-4c2cfce6d01f.jpg)

#### Target 2: Flow Rate 

RMSE: 4.22, 9.9% variance. 

In this case, Rainfall at S. Piero locality and temperature have the greatest influence. 

![18Bilancino_RF_flowrate](https://user-images.githubusercontent.com/43357858/109328482-c48e1380-7859-11eb-893c-6b3a810af870.jpg)

![19Bilancino_RF_FL](https://user-images.githubusercontent.com/43357858/109328504-cbb52180-7859-11eb-981b-b985e196a3cf.jpg)


### Gradient Boost Machine 

#### Target 1: Lake Level 

RMSE: 1.60

![25lake_level_features](https://user-images.githubusercontent.com/43357858/109328790-251d5080-785a-11eb-8d6e-eda717286989.jpg)

![27Bilancino_lakelevel_pred_act](https://user-images.githubusercontent.com/43357858/109328794-25b5e700-785a-11eb-9372-f3723fbbc506.jpg)

#### Target 2: Flow Rate 

RMSE: 3.42 

![21flowrate_features](https://user-images.githubusercontent.com/43357858/109328946-5007a480-785a-11eb-9d06-db808bb149f4.jpg)

![23Bilancino_flowrate_pred_act](https://user-images.githubusercontent.com/43357858/109328949-50a03b00-785a-11eb-9768-1372d641e854.jpg)
